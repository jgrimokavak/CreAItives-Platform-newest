## ğŸ› ï¸ Replit Agent â€” Fix Storage Dashboard & Envâ€‘Safe Trash

### Problems to Solve
1. **Dashboard metrics are wrong** â€“ â€œStorageÂ Usedâ€ and object sizes all read **0Â B**.  
2. The **StorageÂ View** filter (**AllÂ |Â DevÂ |Â Prod**) only updates the table, **not** the stat cards.  
3. **Trash / cleanup** sometimes deletes the other environmentâ€™s files.  
4. Console spam: `wss://localhost:undefined` WebSocket fallback error.

---

### 1Â Â·Â Return real object sizes in the stats API  
**Files:** `server/replitObjectStorage.ts`, `/api/admin/storage/stats`

```ts
// inside listAllObjects()
const { ok, value: bytes } = await client.downloadAsBytes(obj.name);
const size = ok ? bytes.length : 0;   // real byte size
```

* Iterate through every object key from `client.list()` and accumulate the real byte sizes.  
* Cache the totals for **60â€¯s** to keep refresh fast.

---

### 2Â Â·Â Wire environment filter to backend  
* **Frontend (`StorageManagementPage.tsx`)**

```ts
const statsUrl =
  \`/api/admin/storage/stats?environment=\${storageView}\`; // all | dev | prod
```

* **Backend** â€“ in the stats route  
  * If `environment=dev`, sum keys starting with `dev/`.  
  * If `environment=prod`, sum keys starting with `prod/`.  
  * Default (or `all`)Â = aggregate everything.

---

### 3Â Â·Â Prefixâ€‘safe trash & cleanup  
* Add an `environment` column to the image DB record when saving uploads.  
* When trashing (`images.trash = true`), keep the env value.  
* **Cleanup job** (`server/cleanup.ts`)

```ts
const prefix = record.environment === 'dev' ? 'dev/' : 'prod/';
await client.delete(\`\${prefix}trash/\${record.key}\`);
```

*Only* delete keys from the same environment.

---

### 4Â Â·Â Fix WebSocket fallback URL builder  
**File:** `client/src/lib/websocket.ts`

```ts
const port = window.location.port ? \`:\${window.location.port}\` : '';
const wsUrl = \`wss://\${window.location.hostname}\${port}/?token=\${token}\`;
```

Remove retries that generate `localhost:undefined`.

---

### Acceptance Checklist
- Dashboard cards show correct **byte totals** (matches manual `client.list()` check).  
- Switching **DevÂ Only** vs **ProdÂ Only** updates totals and chart accordingly.  
- Trashing or deleting dev images never affects prod, and viceâ€‘versa.  
- No `localhost:undefined` WebSocket errors remain in the console.

---

**Ping me in preview once all four fixes are live.**
