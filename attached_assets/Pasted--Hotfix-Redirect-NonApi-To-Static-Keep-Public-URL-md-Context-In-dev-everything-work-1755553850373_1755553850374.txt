````
# Hotfix_Redirect_NonApi_To_Static_Keep_Public_URL.md
"""
Context:
- In dev everything worked (Vite served the UI; API proxied).
- We changed prod to a split: Static serves the UI; Autoscale serves only /api/*.
- After deploy, opening https://creaitives-platform-2-0.replit.app shows:
  {"message":"API endpoint not found. Frontend is served from static deployment."}
- Reason: https://creaitives-platform-2-0.replit.app is the **API’s system URL**, so it no longer serves the SPA.
- Requirement: keep **that same URL** working for users **today**. If the SPA isn’t on that host, redirect any non-/api path to the Static site. Do not change autoscale sizing.

Objective:
Implement an immediate, safe **redirect hotfix** on the API:
- For any request path **not** starting with `/api/` (and not `/healthz`), return **308 → STATIC_URL** (preserve path/query).
- Ensure the SPA calls the API using the API system URL.
- Verify end-to-end. No other functional changes.

Guardrails:
- Do NOT modify Autoscale machine power (keep 1 vCPU / 2 GiB, max=1).
- Prefer configuration; one minimal code addition for the redirect only.
- If something is ambiguous, write the assumption into the report and proceed.

Plan_First (print concrete values before edits):
1) Detect **API_URL** = current public/system URL of the Autoscale deployment (should be https://creaitives-platform-2-0.replit.app).
2) Detect **STATIC_URL**:
   - If a Static deployment exists, print its URL.
   - If none exists, create one using `.replit.static` or the detected build output (dist/public) with SPA rewrite `/* → /index.html`, then print its URL.
3) Confirm env keys exist: `VITE_PublicApiBaseUrl` (frontend), `Allowed_Web_Origins` and `STATIC_APP_ORIGIN` (API).

Steps:

1) Ensure_Static_Build_And_Deployment
- Build the SPA (npm run build). Publish folder must be the static deployment’s public dir (e.g., dist/public).
- If Static deployment does not exist, create it and attach its default replit.app URL. Record **STATIC_URL**.

2) Wire_Env_Vars (no secrets; print the values you set)
- **Frontend (Static build)**: set `VITE_PublicApiBaseUrl=${API_URL}` and rebuild so the SPA calls the API at API_URL.
- **API (Autoscale)**:
  - `Allowed_Web_Origins=${STATIC_URL}`
  - `STATIC_APP_ORIGIN=${STATIC_URL}`

3) Add_Redirect_On_API (single minimal code change)
- In the main server file (e.g., server/index.ts), **before** any 404 handler, add:
  ```ts
  // Redirect any non-API routes to the Static frontend (hotfix)
  app.get(["/", "/:path(*)"], (req, res, next) => {
    const p = req.path || "/";
    if (p.startsWith("/api/") || p === "/healthz") return next();
    const origin = process.env.STATIC_APP_ORIGIN;
    if (!origin) {
      return res.status(404).json({ message: "API endpoint not found. Frontend is served from static deployment." });
    }
    const url = new URL(origin);
    url.pathname = req.path || "/";
    url.search = req.url.includes("?") ? req.url.slice(req.url.indexOf("?")) : "";
    return res.redirect(308, url.toString());
  });
````

* Commit: `Introduce_StaticRedirect_For_NonApi_To_StaticOrigin`.

4. Redeploy\_Both

* Redeploy **API** (to apply redirect + CORS allowlist).
* Redeploy **Static** (built with `VITE_PublicApiBaseUrl=${API_URL}`).

5. Smoke\_Tests (must run and record)

* GET `https://creaitives-platform-2-0.replit.app/` → **308 → STATIC\_URL** → SPA loads.
* GET `https://creaitives-platform-2-0.replit.app/create` → **308 → STATIC\_URL/create** → SPA loads (rewrite works).
* API sanity:

  * GET `${API_URL}/healthz` → 200.
  * CORS preflight to `${API_URL}/healthz` with `Origin: ${STATIC_URL}` → `Access-Control-Allow-Origin: ${STATIC_URL}` present.
* SPA network calls hit `${API_URL}/api/...` and return 2xx.

6. Reports (write files only; include concrete values)

* `_fix_reports/Detected_Endpoints.txt`  // API\_URL and STATIC\_URL
* `_fix_reports/Env_Wiring_Summary.txt`  // VITE\_PublicApiBaseUrl, Allowed\_Web\_Origins, STATIC\_APP\_ORIGIN
* `_fix_reports/Redirect_Smoke_Test_Report.txt`  // status codes + Location headers
* `_fix_reports/Final_Validation_Report.md`  // PASS/FAIL and any follow-ups

Success Criteria:

* Users hitting **[https://creaitives-platform-2-0.replit.app](https://creaitives-platform-2-0.replit.app)** land on the SPA (via 308 to STATIC\_URL).
* SPA calls the API at **API\_URL** successfully.
* `/api/*` endpoints remain unchanged; `/healthz` is 200.
* CORS allows only **STATIC\_URL**.
  """

```
::contentReference[oaicite:0]{index=0}
```
